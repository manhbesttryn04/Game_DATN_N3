using UnityEngine;
using UnityEngine.UI;

public class EnemyHealth : MonoBehaviour {
	// Thong tin mac dinh cua quai vat, co the thay doi theo tung quai
	public Enemy _Enemy;
	// Lay thong tin thanh mau cua enemy
	public Slider enemyHealthSlider; // Su dung: using UnityEngine.UI;
	public Image Fill;
	//
	public GameObject EnemyParent;
	// Thoi gian khoi tao lai doi tuong
	private float timeInstantiate = 40f;
	// Xac nhan hien lai
	public bool Show = true;
	// Xac nhan da chet
	private bool Die = false;

	// So lan bi tan cong
	private int BiDanh = 0;

	public bool IsBoss = false;
	public bool Delete = false;
	public float scaleBoss = 3f;
	// Xu ly hieu ung mau roi
	public EnemyAnimation enemyBlood;
	// Xu ly hieu ung chet
	public EnemyAnimation enemyDead;

	//
	private Vector2 psitionStart; 
	//
	private void Awake(){
		if (EnemyParent != null) {
			psitionStart = EnemyParent.transform.position;
		}
		// Thay doi thong tin mau va damage theo level
		_Enemy.SetHealthAndDamageByLevel ();
		// Lay thong tin doi duong 
		if (enemyHealthSlider != null) {
			// Thong tin mau cua enemy
			enemyHealthSlider.maxValue = _Enemy.Health.Max;
			enemyHealthSlider.value = _Enemy.Health.Current;
		}
		// Khoi tao mau thanh mau cho tung loai quai
		SetColorSlider (_Enemy.type);
	}

	/// <summary>
	/// Saves the load enemy.
	/// </summary>
	private void SaveLoadEnemy ()
	{
		// Neu no la boss
		if (IsBoss) {
			// Khi da co thong tin duoc luu lai
			if(EnemyManager.LoadBoss () != null){
				//
				if (!Delete) {
					if (EnemyManager.CheckIndexBoss (EnemyManager.LoadBoss (), _Enemy.boss)) {
						this.gameObject.SetActive (false);
						EnemyParent.SetActive (false);
					}
				} else {
					EnemyManager.DeleteIndexBoss (EnemyManager.LoadBoss (), _Enemy.boss);
				}
			}
		}
	}

	private void Update(){
		SaveLoadEnemy ();
	}

	/// <summary>
	/// Contructions the color health.
	/// </summary>
	/// <param name="type">Type.</param>
	private void SetColorSlider(TypeEnemy type){
		if (type == TypeEnemy.DungYen) {
			Fill.color = Color.gray; // Mau xam
		} else if (type == TypeEnemy.DanhGan) {
			Fill.color = Color.blue; // Mau xanh duong
		} else if (type == TypeEnemy.DanhXa) {
			Fill.color = Color.yellow; // Mau vang
		} else if (type == TypeEnemy.Bay) {
			Fill.color = Color.green; // Mau la
		} else if (type == TypeEnemy.LaoVao) {
			Fill.color = Color.red; // Mau do
		}
	}

	// Use this for initialization
	private void Start () {
		//enemyHealthSlider.enabled = false;
		timeInstantiate = 40f;
		// Cap nhat thong tin mau va luc chien thong qua level
	}

	// Xu ly bi tan cong
	public void addDamage(float damage){
		if (damage < 0) {
			return;
		}
		this.BiDanh++;
		// Giam mau 
		_Enemy.Health.Current -= damage;
		enemyHealthSlider.value = _Enemy.Health.Current;
		// TH: Mau bi giam het
		if (EnemyParent != null) {
			pushBack (EnemyParent.transform);
		}
		//
		if (_Enemy.Health.Current <= 0f) {
			Dead ();
		} else {
			// Hien animation mau khi bi tan cong
			displayAnimation (enemyBlood.Graphicss,enemyBlood.GunTips); // Hien mau roi
		}
	}

	/// <summary>
	/// Gets the bi danh.
	/// </summary>
	/// <returns>The bi danh.</returns>
	public int GetBiDanh(){
		return this.BiDanh;
	}

	/// <summary>
	/// Sets the bi danh.
	/// </summary>
	/// <param name="value">Value.</param>
	public void SetBiDanh(int value){
		this.BiDanh = value;
	}

	/// <summary>
	/// Thay vi Destroy luon gameObject thi o day se an enemy sau thoi gian se hien lai
	/// </summary>
	public void Dead(){
		this.BiDanh = 0;
		this.Die = true;
		// Hien animation chet
		displayAnimation (enemyDead.Graphicss,enemyDead.GunTips); // Hien hieu ung chet
		this.gameObject.SetActive (false);
		enemyHealthSlider.gameObject.SetActive (false); // An thanh mau
		// Luu thong tin boss
		if(IsBoss){
			_Enemy.SaveInformationBoss ();
		}
		//
		// Khoi tao moi quai khi chet
		if (Show) {
			//StartCoroutine (CreateEnemy (timeInstantiate));
			Invoke("Instancex",timeInstantiate);
		}
	}

	/// <summary>
	/// Instancex this instance.
	/// </summary>
	private void Instancex(){
		this.Die = false; // Xac nhan song lai
		// Set lai vi tri cua enemy lkhi duoc khoi tao lai
		EnemyParent.transform.position = psitionStart;
		// Gan thanh mau day lai 
		_Enemy.Health.Current = _Enemy.Health.Max; 
		enemyHealthSlider.value = _Enemy.Health.Current; 
		// Hien lai thanh mau
		enemyHealthSlider.gameObject.SetActive (true); // Dieu nay co le khong dung (Xu ly sau)
		this.gameObject.SetActive (true);
	}

	/// <summary>
	/// Gets the dead.
	/// </summary>
	/// <returns><c>true</c>, if dead was gotten, <c>false</c> otherwise.</returns>
	public bool GetDead(){
		return this.Die;
	}

	/// <summary>
	/// Displaies the animation.
	/// </summary>
	/// <param name="Graphics">Graphics.</param>
	/// <param name="GunTip">Gun tip.</param>
	public void displayAnimation(GameObject Graphics,Transform GunTip){
		if (Graphics != null && GunTip != null) {
			if (IsBoss) {
				Graphics.transform.localScale = new Vector2 (scaleBoss, scaleBoss);
			} else {
				Graphics.transform.localScale = new Vector2 (1f, 1f);
			}
			Instantiate (Graphics, GunTip.position, Quaternion.Euler (0, 0, 0));
		}
	}

	private enemyMovingWalk GetEnemyMovingWalk (GameObject enemy)
	{
		if (enemy.GetComponent<enemyMovingWalk> () != null) {
			return EnemyParent.GetComponent<enemyMovingWalk> ();
		}
		return null;
	}

	private void AddToForce (Transform pushObject, enemyMovingWalk enemyWalk)
	{
		// Tim toi mot Rigidbody2D
		Rigidbody2D myBody = pushObject.gameObject.GetComponent<Rigidbody2D> ();
		if (myBody != null) {
			// Gan luc dung yen
			myBody.velocity = Vector2.zero;
		}
	}

	/// <summary>
	/// Pushs the back.
	/// </summary>
	/// <param name="pushObject">Push object.</param>
	public void pushBack(Transform pushObject){
		if (_Enemy.type != TypeEnemy.DungYen) {
			// Lay script EnemyMovingWalk de lay pham vi di chuyen
			enemyMovingWalk enemyWalk = GetEnemyMovingWalk (EnemyParent);
			// Thuc hien day lui enemy
			AddToForce (pushObject, enemyWalk);
		}
	}
}