using UnityEngine;

/// <summary>
/// Flie nay dung de chua thong tin co ban cua nhan vat(mau, mana, sat thuong co ban,...)
/// Thuc hien cac hieu ung khi bi tan cong...
/// </summary>
public class PlayerHealth : MonoBehaviour {

	public static PlayerHealth control; 

	// Thong tin co ban cua nguoi choi
	public Player _Player;
	public bool IsLoad;
	// Thoi gian ton tai sau chet
	public float timeAnimationDie = 2.2f;
	public float timeCancelHurt = 0.5f;

	// Xac nhan dung lai khi bi danh
	private bool Hurt = false;
	// Xac nhan nguoi choi con song hay chet
	private float HealthCurrent;
	private bool Die = false;
	private bool MienKhang = false;
	// Lay animation cua nhan vat
	//private Animator aniePlayer;
	//private ChangePlayer changePlayer;

	/// <summary>
	/// Gets the die.
	/// </summary>
	/// <returns><c>true</c>, if die was gotten, <c>false</c> otherwise.</returns>
	public bool GetDie(){
		return this.Die;
	}

	public bool GetMienKhang(){
		return this.MienKhang;
	}

	public void SetMienKhang(bool value){
		this.MienKhang = value;
	}
	/// <summary>
	/// Gets the hurt.
	/// </summary>
	/// <returns><c>true</c>, if hurt was gotten, <c>false</c> otherwise.</returns>
	public bool GetHurt(){
		return this.Hurt;
	}
	/// <summary>
	/// Awake this instance.
	/// </summary>
	private void Awake(){
		// Khoi tao thong tin ve animaition
		//changePlayer = GetComponent <ChangePlayer>();
		// Load lai thong tin khi bat dau
	}

	// Use this for initialization
	void Start () {
		if (!Die) {
			if (IsLoad) {
				if (_Player.hasExist ()) {
					_Player = _Player.LoadInformation (); // Lay du lieu da luu trong thu muc Data/DataPlayer.dat
					if (_Player.Health.Current == 0.0f) {
						_Player.SetDefault ();
					}
				}
			} else {
				_Player.SetDefault ();
			}
		}
		HealthCurrent = _Player.Health.Current;
		// 
		if (control == null) {
			control = this;
		}
  	}

	private void ExecuteSaveInformation ()
	{
		if (HealthCurrent != _Player.Health.Current) {
			_Player.SaveInformation ();
			HealthCurrent = _Player.Health.Current;
		}
	}

	private void Update(){
		// Luu thong tin 
		ExecuteSaveInformation ();
	}

	/// <summary>
	/// Adds the damage.
	/// </summary>
	/// <param name="damage">Damage.</param>
	public void addDamage(float damage){
		if (!MienKhang) {
			// TH: Khong bi tan cong
			if (damage <= 0) {
				return;
			}
			// Giam mau cho nhan vat
			_Player.SetHealth (0, _Player.Health.Current - damage);
			// Hien animation bi tan cong
			SetAnimationHurt ();
			// TH: Mau bi giam het
			if (_Player.Health.Current <= 0) {
				// Nhan vat se tu vong
				Dead ();
			}
		}
	}

	/// <summary>
	/// Sets the animation hurt.
	/// </summary>
	private void SetAnimationHurt(){
		// hien aniamtion
		PlayerMoving.anim.SetBool ("Hurt",true);
		// Xac nhan hurt de chan di chuyen
		Hurt = true;
		Invoke ("SetBoolHurtTime",timeCancelHurt);
		// Vang ra 1 khoang
		pushBack(this.gameObject.transform);
	}

	/// <summary>
	/// Sets the bool hurt time.
	/// </summary>
	private void SetBoolHurtTime(){
		PlayerMoving.anim.SetBool ("Hurt",false);
		Hurt = false;
	}

	/// <summary>
	/// Sets the information default.
	/// </summary>
	private void SetInformationDefault(){
		// Thay doi thanh mau tro ve 0
		// Truong hop dung phai gai chet
		_Player.Health.Current = 0;
		_Player.Mana.Current = 0;
	}

	/// <summary>
	/// Dead this instance.
	/// </summary>
	public void Dead(){
		// Hien animation chet
		PlayerMoving.anim.SetBool ("Die",true);
		// Set thong tin cua player
		SetInformationDefault();
		// Xac nhan nhan vat da chet
		this.Die = true;
		// Huy nhan vat
		Destroy (this.gameObject,timeAnimationDie);
	}

	/// <summary>
	/// Pushs the back.
	/// </summary>
	/// <param name="pushObject">Push object.</param>
	public void pushBack(Transform pushObject){
		// Luc day
		Vector2 pushDerection = new Vector2 (1f, 0f);
		if (pushObject.transform.localScale.x > 0) {
			pushDerection = new Vector2 (-1f, 0f);
		}
		Rigidbody2D myBody = pushObject.gameObject.GetComponent <Rigidbody2D> ();
		myBody.velocity = Vector2.zero;
		// Gan luc day
		myBody.AddForce (pushDerection, ForceMode2D.Impulse);
	}
}